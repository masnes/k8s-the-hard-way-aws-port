---
- name: Gen CA Cert
  shell:
    cmd: |
      cfssl gencert -initca ca-csr.json | cfssljson -bare ca
    chdir: "{{playbook_dir}}/files"

- name: Gen Admin Cert
  shell:
    cmd: >
      cfssl gencert
      -ca=ca.pem
      -ca-key=ca-key.pem
      -config=ca-config.json
      -profile=kubernetes
      admin-csr.json | cfssljson -bare admin
    chdir: "{{playbook_dir}}/files"

- name: Gen Worker Certs
  shell:
    cmd: >
      cfssl gencert
      -ca=ca.pem
      -ca-key=ca-key.pem
      -config=ca-config.json
      -hostname={{item.instance}},{{item.external_ip}},{{item.internal_ip}}
      -profile=kubernetes
      {{item.instance}}-csr.json | cfssljson -bare {{item.instance}}
    chdir: "{{playbook_dir}}/files"
  with_items:
    - { instance: "worker-0", external_ip: "{{worker_external_ips[0]}}", internal_ip: "{{worker_internal_ip[0]}}"
    - { instance: "worker-1", external_ip: "{{worker_external_ips[1]}}", internal_ip: "{{worker_internal_ip[1]}}"
    - { instance: "worker-2", external_ip: "{{worker_external_ips[2]}}", internal_ip: "{{worker_internal_ip[2]}}"

- name: Gen Controller Manager Client Certificate
  shell:
    cmd: >
      cfssl gencert
      -ca=ca.pem
      -ca-key=ca-key.pem
      -config=ca-config.json
      -profile=kubernetes
      kube-controller-manager-csr.json | cfssljson -bare kube-controller-manager
    chdir: "{{playbook_dir}}/files"

- name: Gen Kube Proxy Client Certificate
  shell:
    cmd: >
      cfssl gencert
      -ca=ca.pem
      -ca-key=ca-key.pem
      -config=ca-config.json
      -profile=kubernetes
      kube-proxy-csr.json | cfssljson -bare kube-proxy
    chdir: "{{playbook_dir}}/files"

- name: Gen Scheduler Client Certificate
  shell:
    cmd: >
      cfssl gencert
      -ca=ca.pem
      -ca-key=ca-key.pem
      -config=ca-config.json
      -profile=kubernetes
      kube-scheduler-csr.json | cfssljson -bare kube-scheduler
    chdir: "{{playbook_dir}}/files"

- name: Gen Service Account Certificate
  shell:
    cmd: >
      cfssl gencert
      -ca=ca.pem
      -ca-key=ca-key.pem
      -config=ca-config.json
      -profile=kubernetes
      service-account-csr.json | cfssljson -bare service-account
    chdir: "{{playbook_dir}}/files"
